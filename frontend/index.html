<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Materias - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
  body {
    background: url('/images/photo-1517816743773-6e0fd518b4a6.jpeg') no-repeat center center fixed;
    background-size: cover;
  }

  main.container {
    background-color: rgba(255, 255, 255, 0.85); 
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
  }
</style>

</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <span class="navbar-brand">Materias</span>
      <button id="logout" class="btn btn-outline-light btn-sm">Logout</button>
    </div>
  </nav>
<!-- Contenedor de alerts -->
  <div id="alertContainer" class="container mt-3"></div>
  <!-- Contenido -->
  <main class="container py-4">
    <h2 class="h4 mb-4">Bienvenido</h2>

    <!-- Botones principales -->
    <div class="d-flex gap-2 mb-4">
      <button id="btnInscribir" class="btn btn-success flex-fill">Inscribir materias</button>
      <button id="btnVer" class="btn btn-secondary flex-fill">Ver materias inscritas</button>
      <button id="btnVerPartners" class="btn btn-secondary flex-fill">Ver Compañeros</button>
    </div>

    <!-- Contenedor dinámico -->
    <div id="contentArea"></div>
  </main>

  <script>
    const APIURL = "http://localhost:5074"; 
    const token = localStorage.getItem('token');
    const studentId = localStorage.getItem('studentId'); 
    if(!token) location.href='/login.html';

    const contentArea = document.getElementById('contentArea');


    async function loadSubjects(){
      const r = await fetch(`${APIURL}/api/enrollments/subjects`, { 
        headers: { Authorization: 'Bearer '+token }
      });
      if(!r.ok){ contentArea.innerHTML = `<div class="alert alert-danger">Error cargando materias</div>`; return; }

      const data = await r.json();
      contentArea.innerHTML = "";

      contentArea.innerHTML = `<div class="alert alert-info">Inscripcion Materias.</div></br>`;

      const list = document.createElement('div');
      list.className = "list-group mb-3";

      data.forEach(s=>{
        const item = document.createElement('label');
        item.className = "list-group-item d-flex align-items-center";
        item.innerHTML = `
          <input class="form-check-input me-2" type="checkbox" data-id="${s.subjectId}">
          <span>${s.title} <small class="text-muted">(${s.professorName})</small></span>
        `;
        list.appendChild(item);
      });

      contentArea.appendChild(list);

      const enrollBtn = document.createElement('button');
      enrollBtn.className = "btn btn-primary w-100";
      enrollBtn.textContent = "Confirmar inscripción";
      enrollBtn.onclick = async ()=>{
        const ids = [...document.querySelectorAll('#contentArea input:checked')]
          .map(n=>parseInt(n.dataset.id));

        const res = await fetch(`${APIURL}/api/enrollments`, {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            Authorization:'Bearer '+token
          },
          body: JSON.stringify({ studentId, subjectIds: ids })
        });

        if(res.status === 201){
             showAlert('Inscripción exitosa', "success");
        } else {
          const err = await res.json();
           showAlert(JSON.stringify(err), "warning");
        }
      };
      contentArea.appendChild(enrollBtn);
    }

    async function loadMySubjects(){
      const r = await fetch(`${APIURL}/api/enrollments/student/${studentId}`, { 
        headers: { Authorization: 'Bearer '+token }
      });
      if(!r.ok){ contentArea.innerHTML = `<div class="alert alert-danger">Error cargando tus materias</div>`; return; }

      const data = await r.json();
      contentArea.innerHTML = "";

      if(data.length === 0){
        contentArea.innerHTML = `<div class="alert alert-info">No tienes materias inscritas.</div>`;
        return;
      }
     contentArea.innerHTML = `<div class="alert alert-info">Materias inscritas.</div></br>`;
      const list = document.createElement('ul');
      list.className = "list-group";
      data.forEach(s=>{
        const li = document.createElement('li');
        li.className = "list-group-item";
        li.textContent = ` Materia: ${s.subjectTitle}  ---- Profesor: ${s.professorName}`;
        list.appendChild(li);
      });
      contentArea.appendChild(list);
    }




     async function loadPartners() {
                const r = await fetch(`${APIURL}/api/enrollments/shared/${studentId}`, {
                    headers: { Authorization: 'Bearer ' + token }
                });

                contentArea.innerHTML = "";

                if (!r.ok) {
                    contentArea.innerHTML = `<div class="alert alert-danger">Error cargando compañeros</div>`;
                    return;
                }

                const data = await r.json();

                if (data.length === 0) {
                    contentArea.innerHTML = `<div class="alert alert-info">No tienes compañeros en tus materias.</div>`;
                    return;
                }

                contentArea.innerHTML = `<div class="alert alert-info">Materias y compañeros.</div></br>`;

                data.forEach(subject => {
                    const card = document.createElement('div');
                    card.className = "card mb-3";
                    card.innerHTML = `
                    <div class="card-header"><strong>${subject.subjectTitle}</strong></div>
                    <ul class="list-group list-group-flush">
                        ${subject.classmates.length > 0 
                        ? subject.classmates.map(c => `<li class="list-group-item">${c}</li>`).join("")
                        : `<li class="list-group-item text-muted">Sin compañeros</li>`}
                    </ul>
                    `;
                    contentArea.appendChild(card);
                });
      }

    



    document.getElementById('btnInscribir').onclick = loadSubjects;
    document.getElementById('btnVer').onclick = loadMySubjects;
    document.getElementById('btnVerPartners').onclick = loadPartners;

    document.getElementById('logout').onclick = ()=>{
      localStorage.removeItem('token');
      localStorage.removeItem('studentId');
      location.href='/login.html';
    };

     function showAlert(message, type = "info") {
      const container = document.getElementById("alertContainer");
      container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
